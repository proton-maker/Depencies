{"version":3,"file":"chunk-millennium-api.js","sources":["../../src/millennium-api.ts"],"sourcesContent":["const isClient = window.location.hostname === 'steamloopback.host';\r\n\r\ndeclare global {\r\n\tinterface Window {\r\n\t\tPLUGIN_LIST: any;\r\n\t\tMILLENNIUM_BACKEND_IPC: typeof backendIPC;\r\n\t\tMILLENNIUM_IPC_SOCKET: WebSocket;\r\n\t\tCURRENT_IPC_CALL_COUNT: number;\r\n\t\tMILLENNIUM_PLUGIN_SETTINGS_STORE: any;\r\n\t}\r\n}\r\n\r\ntype Json = string | number | boolean | null | Json[] | { [key: string]: Json };\r\ntype IPC_types = string | number | boolean | Json;\r\ndeclare const g_PopupManager: any;\r\n\r\nlet millenniumAuthToken: string | undefined = undefined;\r\n\r\nexport function setMillenniumAuthToken(token: string) {\r\n\tmillenniumAuthToken = token;\r\n}\r\n\r\nconst backendIPC = {\r\n\tpostMessage: async (messageId: number, contents: any): Promise<any> => {\r\n\t\tif (!millenniumAuthToken) {\r\n\t\t\tconsole.warn('No Millennium auth token set. This will cause issues with IPC calls.');\r\n\t\t}\r\n\r\n\t\tconst response = await fetch('https://millennium.ipc', {\r\n\t\t\tmethod: 'POST',\r\n\t\t\theaders: {\r\n\t\t\t\t'Content-Type': 'text/plain',\r\n\t\t\t\t'X-Millennium-Auth': millenniumAuthToken,\r\n\t\t\t},\r\n\t\t\tbody: JSON.stringify({ id: messageId, data: contents }),\r\n\t\t});\r\n\r\n\t\treturn await response.json();\r\n\t},\r\n};\r\n\r\nwindow.MILLENNIUM_BACKEND_IPC = backendIPC;\r\n\r\nexport const Millennium = {\r\n\tcallServerMethod: (pluginName: string, methodName: string, kwargs?: any) => {\r\n\t\tconst query = { pluginName, methodName, ...(kwargs && { argumentList: kwargs }) };\r\n\r\n\t\treturn backendIPC\r\n\t\t\t.postMessage(0, query)\r\n\t\t\t.then((res: any) => {\r\n\t\t\t\treturn typeof res.returnValue === 'string' ? decodeURIComponent(escape(atob(res.returnValue))) : res.returnValue;\r\n\t\t\t})\r\n\t\t\t.catch((err: any) => {\r\n\t\t\t\tconsole.error(`Error calling server method ${pluginName}.${methodName}:`, err);\r\n\t\t\t\tthrow err;\r\n\t\t\t});\r\n\t},\r\n\r\n\tfindElement: (doc: Document, selector: string, timeout?: number): Promise<NodeListOf<Element>> =>\r\n\t\tnew Promise((resolve, reject) => {\r\n\t\t\tconst found = doc.querySelectorAll(selector);\r\n\t\t\tif (found.length) return resolve(found);\r\n\r\n\t\t\tconst observer = new MutationObserver(() => {\r\n\t\t\t\tconst match = doc.querySelectorAll(selector);\r\n\t\t\t\tif (match.length) {\r\n\t\t\t\t\tobserver.disconnect();\r\n\t\t\t\t\ttimer && clearTimeout(timer);\r\n\t\t\t\t\tresolve(match);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tobserver.observe(doc.body, { childList: true, subtree: true });\r\n\r\n\t\t\tconst timer =\r\n\t\t\t\ttimeout &&\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tobserver.disconnect();\r\n\t\t\t\t\treject();\r\n\t\t\t\t}, timeout);\r\n\t\t}),\r\n\r\n\t...(isClient && {\r\n\t\texposeObj: <T extends object>(exports: any, obj: T) => Object.assign(exports, obj),\r\n\t\tAddWindowCreateHook: (cb: any) => {\r\n\t\t\tArray.from(g_PopupManager.GetPopups()).forEach(cb);\r\n\t\t\tg_PopupManager.AddPopupCreatedCallback(cb);\r\n\t\t},\r\n\t}),\r\n};\r\n\r\n// @ts-expect-error. The types don't have pluginName on callServerMethod, but it is used in the client.\r\nwindow.Millennium = Millennium;\r\n\r\n// Callable wrapper\r\nexport const callable =\r\n\t<Args extends any[] = [], Return = void | IPC_types>(cb: (route: string, ...args: Args) => Promise<Return>, route: string): ((...args: Args) => Promise<Return>) =>\r\n\t(...args: Args) =>\r\n\t\tcb(route, ...args);\r\n\r\n// Only define pluginSelf if on loopback host\r\nconst m_private_context: any = undefined;\r\nexport const pluginSelf = isClient ? m_private_context : undefined;\r\n\r\nexport const BindPluginSettings = (pluginName: string) => window.MILLENNIUM_PLUGIN_SETTINGS_STORE?.[pluginName]?.settingsStore;\r\n"],"names":["isClient","window","location","hostname","millenniumAuthToken","undefined","setMillenniumAuthToken","token","backendIPC","postMessage","messageId","contents","__awaiter","console","warn","fetch","method","headers","body","JSON","stringify","id","data","_a","sent","json","MILLENNIUM_BACKEND_IPC","Millennium","__assign","callServerMethod","pluginName","methodName","kwargs","query","argumentList","then","res","returnValue","decodeURIComponent","escape","atob","catch","err","error","concat","findElement","doc","selector","timeout","Promise","resolve","reject","found","querySelectorAll","length","observer","MutationObserver","match","disconnect","timer","clearTimeout","observe","childList","subtree","setTimeout","exposeObj","exports","obj","Object","assign","AddWindowCreateHook","cb","Array","from","g_PopupManager","GetPopups","forEach","AddPopupCreatedCallback","callable","route","args","_i","arguments","apply","__spreadArray","pluginSelf","BindPluginSettings","_b","MILLENNIUM_PLUGIN_SETTINGS_STORE","settingsStore"],"mappings":"0DAAA,IAAMA,EAAwC,uBAA7BC,OAAOC,SAASC,SAgB7BC,OAA0CC,EAExC,SAAUC,EAAuBC,GACtCH,EAAsBG,CACvB,CAEA,IAAMC,EAAa,CAClBC,YAAa,SAAOC,EAAmBC,GAAa,OAAAC,OAAA,OAAA,OAAA,EAAA,4DAKlC,OAJZR,GACJS,QAAQC,KAAK,wEAGG,CAAA,EAAMC,MAAM,yBAA0B,CACtDC,OAAQ,OACRC,QAAS,CACR,eAAgB,aAChB,oBAAqBb,GAEtBc,KAAMC,KAAKC,UAAU,CAAEC,GAAIX,EAAWY,KAAMX,cAGtC,MAAA,CAAA,EATUY,EAAAC,OASKC,QAAtB,KAAA,EAAA,MAAA,CAAA,EAAOF,YACP,EAAA,GAGFtB,OAAOyB,uBAAyBlB,EAEzB,IAAMmB,EAAUC,EAAA,CACtBC,iBAAkB,SAACC,EAAoBC,EAAoBC,GAC1D,IAAMC,EAAKL,EAAA,CAAKE,aAAYC,cAAgBC,GAAU,CAAEE,aAAcF,IAEtE,OAAOxB,EACLC,YAAY,EAAGwB,GACfE,KAAK,SAACC,GACN,MAAkC,iBAApBA,EAAIC,YAA2BC,mBAAmBC,OAAOC,KAAKJ,EAAIC,eAAiBD,EAAIC,WACtG,GACCI,MAAM,SAACC,GAEP,MADA7B,QAAQ8B,MAAM,+BAAAC,OAA+Bd,EAAU,KAAAc,OAAIb,EAAU,KAAKW,GACpEA,CACP,EACF,EAEAG,YAAa,SAACC,EAAeC,EAAkBC,GAC9C,OAAA,IAAIC,QAAQ,SAACC,EAASC,GACrB,IAAMC,EAAQN,EAAIO,iBAAiBN,GACnC,GAAIK,EAAME,OAAQ,OAAOJ,EAAQE,GAEjC,IAAMG,EAAW,IAAIC,iBAAiB,WACrC,IAAMC,EAAQX,EAAIO,iBAAiBN,GAC/BU,EAAMH,SACTC,EAASG,aACTC,GAASC,aAAaD,GACtBT,EAAQO,GAEV,GAEAF,EAASM,QAAQf,EAAI5B,KAAM,CAAE4C,WAAW,EAAMC,SAAS,IAEvD,IAAMJ,EACLX,GACAgB,WAAW,WACVT,EAASG,aACTP,GACD,EAAGH,EACL,EArBA,GAuBGhD,GAAY,CACfiE,UAAW,SAAmBC,EAAcC,GAAW,OAAAC,OAAOC,OAAOH,EAASC,EAAvB,EACvDG,oBAAqB,SAACC,GACrBC,MAAMC,KAAKC,eAAeC,aAAaC,QAAQL,GAC/CG,eAAeG,wBAAwBN,EACxC,IAKFtE,OAAO0B,WAAaA,EAGb,IAAMmD,EACZ,SAAqDP,EAAuDQ,GAC5G,OAAA,eAAC,IAAAC,EAAA,GAAAC,EAAA,EAAAA,EAAAC,UAAA5B,OAAA2B,IAAAD,EAAAC,GAAAC,UAAAD,GACA,OAAAV,EAAEY,WAAA,EAAAC,EAAA,CAACL,GAAUC,GAAI,GAAjB,CADD,EAKYK,EAAarF,EADKK,eAC0BA,EAE5CiF,EAAqB,SAACxD,GAAkB,IAAAP,EAAAgE,EAAK,eAAAA,UAAAhE,EAAAtB,OAAOuF,uDAAmC1D,yBAAa2D"}